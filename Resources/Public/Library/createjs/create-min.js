//     Create.js {{ VERSION }} - On-site web editing interface
//     (c) 2011-2012 Henri Bergius, IKS Consortium
//     Create may be freely distributed under the MIT license.
//     For all details and documentation:
//     http://createjs.org/
(function(e,t){e.widget("Midgard.midgardCreate",{options:{toolbar:"full",saveButton:null,state:"browse",highlight:!0,highlightColor:"#67cc08",editorWidgets:{"default":"hallo"},editorOptions:{hallo:{widget:"halloWidget"}},collectionWidgets:{"default":"midgardCollectionAdd"},url:function(){},storagePrefix:"node",workflows:{url:null},notifications:{},vie:null,stanbolUrl:null,dbPediaUrl:null,tags:!1},_create:function(){this.options.vie?this.vie=this.options.vie:(this.vie=new VIE,this.vie.use(new this.vie.RdfaService),this.options.stanbolUrl&&this.vie.use(new this.vie.StanbolService({proxyDisabled:!0,url:this.options.stanbolUrl})),this.options.dbPediaUrl&&this.vie.use(new this.vie.DBPediaService({proxyDisabled:!0,url:this.options.dbPediaUrl})));var e=this;window.setTimeout(function(){e._checkSession()},10),this._enableToolbar(),this._saveButton(),this._editButton(),this._prepareStorage(),this.element.midgardWorkflows&&this.element.midgardWorkflows(this.options.workflows),this.element.midgardNotifications&&this.element.midgardNotifications(this.options.notifications)},_prepareStorage:function(){this.element.midgardStorage({vie:this.vie,url:this.options.url}),this.element.bind("midgardstoragesave",function(){e("#midgardcreate-save a").html('Saving <i class="icon-upload"></i>')}),this.element.bind("midgardstoragesaved midgardstorageerror",function(){e("#midgardcreate-save a").html('Save <i class="icon-ok"></i>')})},_init:function(){this.setState(this.options.state)},setState:function(e){this._setOption("state",e),e==="edit"?this._enableEdit():this._disableEdit(),this._setEditButtonState(e)},showNotification:function(e){if(this.element.midgardNotifications)return this.element.midgardNotifications("create",e)},configureEditor:function(e,t,n){this.options.editorOptions[e]={widget:t,options:n}},setEditorForContentType:function(e,n){if(this.options.editorOptions[n]===t&&n!==null)throw new Error("No editor "+n+" configured");this.options.editorWidgets[e]=n},setEditorForProperty:function(e,n){if(this.options.editorOptions[n]===t&&n!==null)throw new Error("No editor "+n+" configured");this.options.editorWidgets[e]=n},_checkSession:function(){if(!Modernizr.sessionstorage)return;var e=this.options.storagePrefix+"Midgard.create.toolbar";sessionStorage.getItem(e)&&this._setOption("toolbar",sessionStorage.getItem(e));var t=this.options.storagePrefix+"Midgard.create.state";sessionStorage.getItem(t)&&this.setState(sessionStorage.getItem(t)),this.element.bind("midgardcreatestatechange",function(e,n){sessionStorage.setItem(t,n.state)})},_saveButton:function(){return this.options.saveButton?this.options.saveButton:(e(".create-ui-toolbar-statustoolarea .create-ui-statustools",this.element).append(e('<li id="midgardcreate-save"><a class="create-ui-btn">Save <i class="icon-ok"></i></a></li>')),this.options.saveButton=e("#midgardcreate-save",this.element),this.options.saveButton.hide(),this.options.saveButton)},_editButton:function(){var t=this;e(".create-ui-toolbar-statustoolarea .create-ui-statustools",this.element).append(e('<li id="midgardcreate-edit"></li>')),e("#midgardcreate-edit",this.element).bind("click",function(){if(t.options.state==="edit"){t.setState("browse");return}t.setState("edit")})},_setEditButtonState:function(t){var n={edit:'<a class="create-ui-btn">Cancel <i class="icon-remove"></i></a>',browse:'<a class="create-ui-btn">Edit <i class="icon-edit"></i></a>'},r=e("#midgardcreate-edit",this.element);if(!r)return;t==="edit"&&r.addClass("selected"),r.html(n[t])},_enableToolbar:function(){var e=this;this.element.bind("midgardtoolbarstatechange",function(t,n){Modernizr.sessionstorage&&sessionStorage.setItem(e.options.storagePrefix+"Midgard.create.toolbar",n.display),e._setOption("toolbar",n.display)}),this.element.midgardToolbar({display:this.options.toolbar,vie:this.vie})},_enableEdit:function(){this._setOption("state","edit");var t=this,n={toolbarState:t.options.display,disabled:!1,vie:t.vie,widgets:t.options.editorWidgets,editors:t.options.editorOptions,collectionWidgets:t.options.collectionWidgets};t.options.enableEditor&&(n[enableEditor]=t.options.enableEditor),t.options.disableEditor&&(n[disableEditor]=t.options.disableEditor),e("[about]",this.element).each(function(){var r=this;if(t.options.highlight){var i=function(n,i){if(!e(i.element).is(":visible"))return;if(i.entityElement.get(0)!==r)return;i.element.effect("highlight",{color:t.options.highlightColor},3e3)};e(this).bind("midgardeditableenableproperty",i)}e(this).bind("midgardeditabledisable",function(){e(this).unbind("midgardeditableenableproperty",i)}),t.options.tags&&e(this).bind("midgardeditableenable",function(n,i){if(n.target!==r)return;e(this).midgardTags({vie:t.vie,entityElement:i.entityElement,entity:i.instance})}),e(this).midgardEditable(n)}),this._trigger("statechange",null,{state:"edit"})},_disableEdit:function(){var t=this,n={disabled:!0,vie:t.vie,editorOptions:t.options.editorOptions};e("[about]",this.element).each(function(){e(this).midgardEditable(n),e(this).removeClass("ui-state-disabled")}),this._setOption("state","browse"),this._trigger("statechange",null,{state:"browse"})}})})(jQuery),function(e,t){e.widget("Midgard.midgardCollectionAdd",{options:{editingWidgets:null,collection:null,model:null,definition:null,view:null,disabled:!1,vie:null,editableOptions:null},_create:function(){this.addButtons=[];var e=this;if(!e.options.collection.localStorage)try{e.options.collection.url=e.options.model.url()}catch(t){window.console&&console.log(t)}e.options.collection.bind("add",function(t){t.primaryCollection=e.options.collection,e.options.vie.entities.add(t),t.collection=e.options.collection}),e.options.collection.bind("add remove reset",e.checkCollectionConstraints,e),e._bindCollectionView(e.options.view)},_bindCollectionView:function(e){var t=this;e.bind("add",function(e){e.$el.effect("slide",function(){t._makeEditable(e)})})},_makeEditable:function(e){this.options.editableOptions.disabled=this.options.disabled,this.options.editableOptions.model=e.model,e.$el.midgardEditable(this.options.editableOptions)},_init:function(){if(this.options.disabled){this.disable();return}this.enable()},hideButtons:function(){_.each(this.addButtons,function(e){e.hide()})},showButtons:function(){_.each(this.addButtons,function(e){e.show()})},checkCollectionConstraints:function(){if(this.options.disabled)return;if(!this.options.view.canAdd()){this.hideButtons();return}if(!this.options.definition){this.showButtons();return}if(!this.options.definition.max||this.options.definition.max===-1){this.showButtons();return}if(this.options.collection.length<this.options.definition.max){this.showButtons();return}this.hideButtons()},enable:function(){var t=this,n=e('<button class="btn"><i class="icon-plus"></i> Add</button>').button();n.addClass("midgard-create-add"),n.click(function(){t.addItem(n)}),e(t.options.view.el).after(n),t.addButtons.push(n),t.checkCollectionConstraints()},disable:function(){_.each(this.addButtons,function(e){e.remove()}),this.addButtons=[]},_getTypeActions:function(e){var t=this,n=[];return _.each(this.options.definition.range,function(r){var i=t.options.collection.vie.namespaces.uri(r);if(!t.options.view.canAdd(i))return;n.push({name:r,label:r,cb:function(){t.options.collection.add({"@type":r},e)},className:"create-ui-btn"})}),n},addItem:function(t,n){var r={};if(this.options.definition&&this.options.definition.range){if(this.options.definition.range.length!==1){e("body").midgardNotifications("create",{bindTo:t,gravity:"L",body:"Choose type to add",timeout:0,actions:this._getTypeActions(n)});return}r["@type"]=this.options.definition.range[0]}this.options.collection.add({},n)}})}(jQuery),function(e,t){e.widget("Midgard.midgardCollectionAddBetween",e.Midgard.midgardCollectionAdd,{_bindCollectionView:function(e){var t=this;e.bind("add",function(e){t._makeEditable(e),t._refreshButtons()}),e.bind("remove",function(){t._refreshButtons()})},_refreshButtons:function(){var e=this;window.setTimeout(function(){e.disable(),e.enable()},1)},prepareButton:function(t){var n=this,r=e('<button class="btn"><i class="icon-plus"></i></button>').button();return r.addClass("midgard-create-add"),r.click(function(){n.addItem(r,{at:t})}),r},enable:function(){var t=this,n=t.prepareButton(0);e(t.options.view.el).prepend(n),t.addButtons.push(n),e.each(t.options.view.entityViews,function(n,r){var i=t.options.collection.indexOf(r.model),s=t.prepareButton(i+1);e(r.el).append(s),t.addButtons.push(s)}),this.checkCollectionConstraints()},disable:function(){var t=this;e.each(t.addButtons,function(e,t){t.remove()}),t.addButtons=[]}})}(jQuery),function(e,t){e.widget("Midgard.midgardEditable",{options:{editables:[],collections:[],model:null,editors:{hallo:{widget:"halloWidget",options:{}}},widgets:{"default":"hallo"},collectionWidgets:{"default":"midgardCollectionAdd"},toolbarState:"full",vie:null,disabled:!1},_create:function(){this.vie=this.options.vie;if(!this.options.model){var e=this;this.vie.load({element:this.element}).from("rdfa").execute().done(function(t){e.options.model=t[0]})}},_init:function(){if(this.options.disabled){this.disable();return}this.enable()},findEditableElements:function(t){this.vie.service("rdfa").findPredicateElements(this.options.model.id,e("[property]",this.element),!1).each(t)},enable:function(){var t=this;if(!this.options.model)return;this.findEditableElements(function(){return t._enableProperty(e(this))}),this._trigger("enable",null,{instance:this.options.model,entityElement:this.element});if(!this.vie.services.rdfa)return;_.each(this.vie.service("rdfa").views,function(e){if(e instanceof t.vie.view.Collection&&t.options.model===e.owner){var n=e.collection.predicate,r=t.enableCollection({model:t.options.model,collection:e.collection,property:n,definition:t.getAttributeDefinition(n),view:e,element:e.el,vie:t.vie,editableOptions:t.options});t.options.collections.push(r)}})},disable:function(){var t=this;e.each(this.options.editables,function(n,r){t.disableEditor({widget:t,editable:r,entity:t.options.model,element:e(this)})}),this.options.editables=[],e.each(this.options.collections,function(e,n){t.disableCollection({widget:t,model:t.options.model,element:n,vie:t.vie,editableOptions:t.options})}),this.options.collections=[],this._trigger("disable",null,{instance:this.options.model,entityElement:this.element})},getElementPredicate:function(e){return this.vie.service("rdfa").getElementPredicate(e)},_enableProperty:function(e){var t=this,n=this.getElementPredicate(e);if(!n)return!0;if(this.options.model.get(n)instanceof Array)return!0;var r=this.enableEditor({widget:this,element:e,entity:this.options.model,property:n,vie:this.vie,modified:function(r){var i={};i[n]=r,t.options.model.set(i,{silent:!0}),t._trigger("changed",null,{property:n,instance:t.options.model,element:e,entityElement:t.element})},activated:function(){t._trigger("activated",null,{property:n,instance:t.options.model,element:e,entityElement:t.element})},deactivated:function(){t._trigger("deactivated",null,{property:n,instance:t.options.model,element:e,entityElement:t.element})}});r&&this._trigger("enableproperty",null,{editable:r,property:n,instance:this.options.model,element:e,entityElement:this.element}),this.options.editables.push(r)},_editorName:function(e){if(this.options.widgets[e.property]!==t)return this.options.widgets[e.property];var n="default",r=this.getAttributeDefinition(e.property);return r&&(n=r.range[0]),this.options.widgets[n]!==t?this.options.widgets[n]:this.options.widgets["default"]},_editorWidget:function(e){return this.options.editors[e].widget},_editorOptions:function(e){return this.options.editors[e].options},getAttributeDefinition:function(e){var t=this.options.model.get("@type");if(!t)return;if(!t.attributes)return;return t.attributes.get(e)},enableEditor:function(t){var n=this._editorName(t);if(n===null)return;var r=this._editorWidget(n);t.editorOptions=this._editorOptions(n),t.disabled=!1;if(typeof e(t.element)[r]!="function")throw new Error(r+" widget is not available");return e(t.element)[r](t),e(t.element).data("createWidgetName",r),e(t.element)},disableEditor:function(t){var n=e(t.element).data("createWidgetName");t.disabled=!0,n&&(e(t.element)[n](t),e(t.element).removeClass("ui-state-disabled"))},collectionWidgetName:function(e){if(this.options.collectionWidgets[e.property]!==t)return this.options.collectionWidgets[e.property];var n="default",r=this.getAttributeDefinition(e.property);return r&&(n=r.range[0]),this.options.collectionWidgets[n]!==t?this.options.collectionWidgets[n]:this.options.collectionWidgets["default"]},enableCollection:function(t){var n=this.collectionWidgetName(t);if(n===null)return;t.disabled=!1;if(typeof e(t.element)[n]!="function")throw new Error(n+" widget is not available");return e(t.element)[n](t),e(t.element).data("createCollectionWidgetName",n),e(t.element)},disableCollection:function(t){var n=e(t.element).data("createCollectionWidgetName");if(n===null)return;t.disabled=!0,n&&(e(t.element)[n](t),e(t.element).removeClass("ui-state-disabled"))}})}(jQuery),function(e,t){e.widget("Create.editWidget",{options:{disabled:!1,vie:null},enable:function(){this.element.attr("contenteditable","true")},disable:function(e){this.element.attr("contenteditable","false")},_create:function(){this._registerWidget(),this._initialize()},_init:function(){if(this.options.disabled){this.disable();return}this.enable()},_initialize:function(){var t=this,n=this.element.html();this.element.bind("blur keyup paste",function(r){if(t.options.disabled)return;var i=e(this).html();n!==i&&(n=i,t.options.modified(i))})},_registerWidget:function(){this.element.data("createWidgetName",this.widgetName)}})}(jQuery),function(e,t){e.widget("Create.alohaWidget",e.Create.editWidget,{enable:function(){this._initialize(),this.options.disabled=!1},disable:function(){Aloha.jQuery(this.options.element.get(0)).mahalo(),this.options.disabled=!0},_initialize:function(){var e=this.options,t,n=Aloha.jQuery(e.element.get(0)).aloha();_.each(Aloha.editables,function(e){e.obj.get(0)===n.get(0)&&(t=e)});if(!t)return;t.vieEntity=e.entity,Aloha.bind("aloha-editable-activated",function(n,r){if(r.editable!==t)return;e.activated()}),Aloha.bind("aloha-editable-deactivated",function(n,r){if(r.editable!==t)return;e.deactivated()}),Aloha.bind("aloha-smart-content-changed",function(n,r){if(r.editable!==t)return;if(!r.editable.isModified())return!0;e.modified(r.editable.getContents()),r.editable.setUnmodified()})}})}(jQuery),function(e,t){e.widget("Create.halloWidget",e.Create.editWidget,{options:{editorOptions:{},disabled:!0,toolbarState:"full",vie:null,entity:null},enable:function(){e(this.element).hallo({editable:!0}),this.options.disabled=!1},disable:function(){e(this.element).hallo({editable:!1}),this.options.disabled=!0},_initialize:function(){e(this.element).hallo(this.getHalloOptions());var t=this;e(this.element).bind("halloactivated",function(e,n){t.options.activated()}),e(this.element).bind("hallodeactivated",function(e,n){t.options.deactivated()}),e(this.element).bind("hallomodified",function(e,n){t.options.modified(n.content),n.editable.setUnmodified()}),e(document).bind("midgardtoolbarstatechange",function(n,r){if(r.display===t.options.toolbarState)return;t.options.toolbarState=r.display,e(t.element).hallo(t.getHalloOptions())})},getHalloOptions:function(){var t={plugins:{halloformat:{},halloblock:{},hallolists:{},hallolink:{},halloimage:{entity:this.options.entity}},buttonCssClass:"create-ui-btn-small",placeholder:"["+this.options.property+"]"};return typeof this.element.annotate=="function"&&this.options.vie.services.stanbol&&(t.plugins.halloannotate={vie:this.options.vie}),this.options.toolbarState==="full"?(t.parentElement=e(".create-ui-toolbar-dynamictoolarea .create-ui-tool-freearea"),t.toolbar="halloToolbarFixed"):(t.showAlways=!1,t.toolbar="halloToolbarContextual"),_.extend(t,this.options.editorOptions)}})}(jQuery),function(e,t){var n=[],r=function(t,r){var i={class_prefix:"midgardNotifications",timeout:3e3,auto_show:!0,body:"",bindTo:null,gravity:"T",effects:{onShow:function(e,t){e.animate({opacity:"show"},600,t)},onHide:function(e,t){e.animate({opacity:"hide"},600,t)}},actions:[],callbacks:{}},s={},o={},u=null,a=null,f=null,l=t,c=null,h={constructor:function(e){s=_.extend(i,e||{}),o={container:s.class_prefix+"-container",item:{wrapper:s.class_prefix+"-item",arrow:s.class_prefix+"-arrow",disregard:s.class_prefix+"-disregard",content:s.class_prefix+"-content",actions:s.class_prefix+"-actions",action:s.class_prefix+"-action"}},this._generate()},getId:function(){return a},getElement:function(){return u},_generate:function(){var t=this,r,i,f=null;u=r=e('<div class="'+o.item.wrapper+'-outer"/>'),r.css({display:"none"}),i=e('<div class="'+o.item.wrapper+'-inner"/>'),i.appendTo(r);if(s.bindTo){r.addClass(o.item.wrapper+"-binded");var h=e('<div class="'+o.item.arrow+'"/>');h.appendTo(r)}else r.addClass(o.item.wrapper+"-normal");f=e('<div class="'+o.item.content+'"/>'),f.html(s.body),f.appendTo(i);if(s.actions.length){var p=e('<div class="'+o.item.actions+'"/>');p.appendTo(i),e.each(s.actions,function(n,r){var i=e('<button name="'+r.name+'" class="button-'+r.name+'">'+r.label+"</button>").button();i.bind("click",function(e){c?r.cb(e,c,t):r.cb(e,t)}),r.className&&i.addClass(r.className),p.append(i)})}u.bind("click",function(e){s.callbacks.onClick?s.callbacks.onClick(e,t):c||t.close()}),s.auto_show&&this.show(),this._setPosition(),a=n.push(this),l.append(u)},_calculatePositionForGravity:function(e,t,n,r){e.find("."+o.item.arrow).addClass(o.item.arrow+"_"+t);switch(t){case"TL":return{left:n.left,top:n.top+n.height+"px"};case"TR":return{left:n.left+n.width-r.width+"px",top:n.top+n.height+"px"};case"BL":return{left:n.left+"px",top:n.top-r.height+"px"};case"BR":return{left:n.left+n.width-r.width+"px",top:n.top-r.height+"px"};case"LT":return{left:n.left+n.width+"px",top:n.top+"px"};case"LB":return{left:n.left+n.width+"px",top:n.top+n.height-r.height+"px"};case"RT":return{left:n.left-r.width+"px",top:n.top+"px"};case"RB":return{left:n.left-r.width+"px",top:n.top+n.height-r.height+"px"};case"T":return{left:n.left+n.width/2-r.width/2+"px",top:n.top+n.height+"px"};case"R":return{left:n.left-r.width+"px",top:n.top+n.height/2-r.height/2+"px"};case"B":return{left:n.left+n.width/2-r.width/2+"px",top:n.top-r.height+"px"};case"L":return{left:n.left+n.width+"px",top:n.top+n.height/2-r.height/2+"px"}}},_isFixed:function(e){if(e===document)return!1;if(e.css("position")==="fixed")return!0;var t=e.offsetParent();return t.get(0)===e.get(0)?!1:this._isFixed(t)},_setPosition:function(){if(s.bindTo){itemDimensions={width:u.width()?u.width():280,height:u.height()?u.height():109},f=e(s.bindTo);var t={},r={width:f.outerWidth(),height:f.outerHeight()};this._isFixed(f)?(t.position="fixed",r.left=f.offset().left,r.top=f.position().top):(t.position="absolute",r.left=f.offset().left,r.top=f.offset().top);var i=this._calculatePositionForGravity(u,s.gravity,r,itemDimensions);t.top=i.top,t.left=i.left,u.css(t);return}s.position||(s.position="top right");var o=e(".create-ui-toolbar-wrapper").outerHeight(!0)+6;i={position:"fixed"};var a=function(t){var n=0;return e.each(t,function(e,t){if(!t)return;n+=t.getElement().height()}),n};s.position.match(/top/)&&(i.top=o+a(n)+"px"),s.position.match(/bottom/)&&(i.bottom=n.length-1*item.height()+item.height()+10+"px"),s.position.match(/right/)&&(i.right="20px"),s.position.match(/left/)&&(i.left="20px"),u.css(i)},show:function(){var t=this,n,r,i,o,a,f;s.callbacks.beforeShow&&s.callbacks.beforeShow(t);if(s.bindTo){var l=e(s.bindTo);n=e(window).scrollTop(),r=e(window).scrollTop()+e(window).height(),o=parseFloat(u.offset().top,10),a=l.offset().top,f=l.outerHeight(),a<o&&(o=a),i=parseFloat(u.offset().top,10)+u.height(),a+f>i&&(i=a+f)}s.timeout>0&&!s.actions.length&&setTimeout(function(){t.close()},s.timeout),s.bindTo&&(o<n||o>r)||i<n||i>r?e("html, body").stop().animate({scrollTop:o},500,"easeInOutExpo",function(){s.effects.onShow(u,function(){s.callbacks.afterShow&&s.callbacks.afterShow(t)})}):s.effects.onShow(u,function(){s.callbacks.afterShow&&s.callbacks.afterShow(t)})},close:function(){var e=this;s.callbacks.beforeClose&&s.callbacks.beforeClose(e),s.effects.onHide(u,function(){s.callbacks.afterClose&&s.callbacks.afterClose(e),e.destroy()})},destroy:function(){var t=this;e.each(n,function(e,r){r&&r.getId()==t.getId()&&delete n[e]}),e(u).remove()},setStory:function(e){c=e},setName:function(e){u.addClass(o.item.wrapper+"-custom-"+e),this.name=e}};return h.constructor(r),delete h.constructor,h},i=function(t,n){var i={},s={},o={},u={},a=null,f=null,l=null,c={constructor:function(e){s=_.extend(i,e||{})},setStoryline:function(t){var n={content:"",actions:[],show_actions:!0,notification:{},back:null,back_label:null,forward:null,forward_label:null,beforeShow:null,afterShow:null,beforeClose:null,afterClose:null};o={},_current_item=null,a=null,f=null,l=null;var r=this;return e.each(t,function(t,i){var s=e.extend({},n,i);s.name=t;var u=e.extend({},n.notification,i.notification||{});u.body=s.content,u.auto_show=!1,s.actions.length&&(u.delay=0),u.callbacks={beforeShow:function(e){s.beforeShow&&s.beforeShow(e,r)},afterShow:function(e){s.afterShow&&s.afterShow(e,r)},beforeClose:function(e){s.beforeClose&&s.beforeClose(e,r)},afterClose:function(e){s.afterClose&&s.afterClose(e,r),a=e.name}},u.actions=[],s.show_actions&&(s.back&&(back_label=s.back_label,back_label||(back_label="Back"),u.actions.push({name:"back",label:back_label,cb:function(e,t,n){t.previous()}})),s.forward&&(forward_label=s.forward_label,forward_label||(forward_label="Back"),u.actions.push({name:"forward",label:forward_label,cb:function(e,t,n){t.next()}})),s.actions.length&&e.each(s.actions,function(e,t){u.actions.push(s.actions[e])})),f||(f=t),l=t,s.notification=u,o[t]=s}),o},start:function(){this._showNotification(o[f])},stop:function(){_current_item.close(),_current_item=null,a=null},next:function(){_current_item.close(),o[_current_item.name].forward?(next_item=o[_current_item.name].forward,this._showNotification(o[next_item])):this._showNotification(o[l])},previous:function(){a?(_current_item.close(),o[_current_item.name].back?(prev_item=o[_current_item.name].back,this._showNotification(o[prev_item])):this._showNotification(o[a])):this.stop()},_showNotification:function(t){return _current_item=new r(e("body"),t.notification),_current_item.setStory(this),_current_item.setName(t.name),_current_item.show(),_current_item}};return c.constructor(t),delete c.constructor,n&&c.setStoryline(n),c},s={start:{content:"Welcome to CreateJS tutorial!",forward:"toolbar_toggle",forward_label:"Start tutorial",actions:[{name:"quit",label:"Quit",cb:function(e,t,n){t.stop()}}]},toolbar_toggle:{content:"This is the CreateJS toolbars toggle button.<br />You can hide and show the full toolbar by clicking here.<br />Try it now.",forward:"edit_button",show_actions:!1,afterShow:function(t,n){e("body").bind("midgardtoolbarstatechange",function(t,r){r.display=="full"&&(n.next(),e("body").unbind("midgardtoolbarstatechange"))})},notification:{bindTo:"#midgard-bar-hidebutton",timeout:0,gravity:"TL"}},edit_button:{content:"This is the edit button.<br />Try it now.",show_actions:!1,afterShow:function(t,n){e("body").bind("midgardcreatestatechange",function(t,r){r.state=="edit"&&(n.next(),e("body").unbind("midgardcreatestatechange"))})},notification:{bindTo:".ui-button[for=midgardcreate-edit]",timeout:0,gravity:"TL"}},end:{content:"Thank you for watching!<br />Happy content editing times await you!"}};e.widget("Midgard.midgardNotifications",{options:{notification_defaults:{class_prefix:"midgardNotifications",position:"top right"}},_create:function(){this.classes={container:this.options.notification_defaults.class_prefix+"-container"},e("."+this.classes.container,this.element).length?(this.container=e("."+this.classes.container,this.element),this._parseFromDOM()):(this.container=e('<div class="'+this.classes.container+'" />'),this.element.append(this.container))},destroy:function(){this.container.remove(),e.Widget.prototype.destroy.call(this)},_init:function(){},_parseFromDOM:function(e){},showStory:function(e,t){var n=new i(e,t);return n.start(),n},create:function(t){return t=e.extend({},this.options.notification_defaults,t||{}),item=new r(this.container,t),item.show(),item},showTutorial:function(){this.showStory({},s)}})}(jQuery),function(e,t){e.widget("Midgard.midgardStorage",{saveEnabled:!0,options:{localStorage:!1,removeLocalstorageOnIgnore:!0,vie:null,url:"",autoSave:!1,autoSaveInterval:5e3,saveReferencedNew:!1,saveReferencedChanged:!1,editableNs:"midgardeditable"},_create:function(){var t=this;this.changedModels=[],window.localStorage&&(this.options.localStorage=!0),this.vie=this.options.vie,this.vie.entities.bind("add",function(e){e.url=t.options.url,e.toJSON=e.toJSONLD}),e("#midgardcreate-save").click(function(){t._saveRemote({success:function(){e("#midgardcreate-save").button({disabled:!0})},error:function(){}})}),t._bindEditables(),t.options.autoSave&&t._autoSave()},_autoSave:function(){var t=this;t.saveEnabled=!0;var n=function(){if(!t.saveEnabled)return;if(t.changedModels.length===0)return;t._saveRemote({success:function(){e("#midgardcreate-save").button({disabled:!0})},error:function(){}})},r=window.setInterval(n,t.options.autoSaveInterval);this.element.bind("startPreventSave",function(){r&&(window.clearInterval(r),r=null),t.disableSave()}),this.element.bind("stopPreventSave",function(){r||(r=window.setInterval(n,t.options.autoSaveInterval)),t.enableSave()})},enableSave:function(){this.saveEnabled=!0},disableSave:function(){this.saveEnabled=!1},_bindEditables:function(){var t=this,n=[],r;t.element.bind(t.options.editableNs+"changed",function(n,r){_.indexOf(t.changedModels,r.instance)===-1&&t.changedModels.push(r.instance),t._saveLocal(r.instance),e("#midgardcreate-save").button({disabled:!1})}),t.element.bind(t.options.editableNs+"disable",function(n,r){t._restoreLocal(r.instance),e("#midgardcreate-save").hide()}),t.element.bind(t.options.editableNs+"enable",function(r,i){e("#midgardcreate-save").button({disabled:!0}),e("#midgardcreate-save").show(),i.instance._originalAttributes||(i.instance._originalAttributes=_.clone(i.instance.attributes)),!i.instance.isNew()&&t._checkLocal(i.instance)&&n.push(i.instance)}),t.element.bind("midgardcreatestatechange",function(i,s){if(s.state==="browse"||n.length===0){n=[],r&&r.close();return}r=e("body").midgardNotifications("create",{bindTo:"#midgardcreate-edit a",gravity:"TR",body:n.length+" items on this page have local modifications",timeout:0,actions:[{name:"restore",label:"Restore",cb:function(){_.each(n,function(e){t._readLocal(e)}),n=[],r=null},className:"create-ui-btn"},{name:"ignore",label:"Ignore",cb:function(e,i){t.options.removeLocalstorageOnIgnore&&_.each(n,function(e){t._removeLocal(e)}),i.close(),n=[],r=null},className:"create-ui-btn"}]})}),t.element.bind("midgardstorageloaded",function(n,r){_.indexOf(t.changedModels,r.instance)===-1&&t.changedModels.push(r.instance),e("#midgardcreate-save").button({disabled:!1})})},_saveRemote:function(t){var n=this;if(n.changedModels.length===0)return;n._trigger("save",null,{models:n.changedModels});var r=n.changedModels.length;r>1?notification_msg=r+" objects saved successfully":(subject=n.changedModels[0].getSubjectUri(),notification_msg="Object with subject "+subject+" saved successfully"),n.disableSave(),_.each(n.changedModels,function(i){_.each(i.attributes,function(e,t){if(!e||!e.isCollection)return;e.each(function(e){if(n.changedModels.indexOf(e)!==-1)return;if(e.isNew()&&n.options.saveReferencedNew)return e.save();if(e.hasChanged()&&n.options.saveReferencedChanged)return e.save()})}),i.save(null,{success:function(){i._originalAttributes=_.clone(i.attributes),n._removeLocal(i),setTimeout(function(){n.changedModels.splice(n.changedModels.indexOf(i),1)},0),r--,r<=0&&(n._trigger("saved",null,{}),t.success(),e("body").midgardNotifications("create",{body:notification_msg}),n.enableSave())},error:function(r,s){notification_msg="Error occurred while saving",s.responseText&&(notification_msg=notification_msg+":<br />"+s.responseText),t.error(),e("body").midgardNotifications("create",{body:notification_msg,timeout:0}),n._trigger("error",null,{instance:i})}})})},_saveLocal:function(e){if(!this.options.localStorage)return;if(e.isNew()){if(!e.primaryCollection)return;return this._saveLocalReferences(e.primaryCollection.subject,e.primaryCollection.predicate,e)}localStorage.setItem(e.getSubjectUri(),JSON.stringify(e.toJSONLD()))},_getReferenceId:function(e,t){return e.id+":"+t},_saveLocalReferences:function(e,t,n){if(!this.options.localStorage)return;if(!e||!t)return;var r=this,i=e+":"+t,s=n.toJSONLD();if(localStorage.getItem(i)){var o=JSON.parse(localStorage.getItem(i)),u=_.pluck(o,"@").indexOf(s["@"]);u!==-1?o[u]=s:o.push(s),localStorage.setItem(i,JSON.stringify(o));return}localStorage.setItem(i,JSON.stringify([s]))},_checkLocal:function(e){if(!this.options.localStorage)return!1;var t=localStorage.getItem(e.getSubjectUri());return t?!0:!1},_readLocal:function(e){if(!this.options.localStorage)return;var t=localStorage.getItem(e.getSubjectUri());if(!t)return;e._originalAttributes||(e._originalAttributes=_.clone(e.attributes));var n=JSON.parse(t),r=this.vie.entities.addOrUpdate(n,{overrideAttributes:!0});this._trigger("loaded",null,{instance:r})},_readLocalReferences:function(e,t,n){if(!this.options.localStorage)return;var r=this._getReferenceId(e,t),i=localStorage.getItem(r);if(!i)return;n.add(JSON.parse(i))},_restoreLocal:function(e){var t=this;if(!e)return;_.each(e.attributes,function(e,n){if(e instanceof t.vie.Collection){var r=[];e.forEach(function(e){e.isNew()&&r.push(e)}),e.remove(r)}});if(!e.changedAttributes()){e._originalAttributes&&e.set(e._originalAttributes);return}e.set(e.previousAttributes())},_removeLocal:function(e){if(!this.options.localStorage)return;localStorage.removeItem(e.getSubjectUri())}})}(jQuery),function(e,t){e.widget("Midgard.midgardWorkflows",{options:{url:function(e){},renderers:{button:function(t,n,r,i){return button_id="midgardcreate-workflow_"+n.get("name"),html=e('<button class="create-ui-btn" id="'+button_id+'">'+n.get("label")+"</button>").button(),html.bind("click",function(e){r(t,n,i)}),html}},action_types:{backbone_save:function(e,t,n){copy_of_url=e.url,original_model=e.clone(),original_model.url=copy_of_url,action=t.get("action"),action.url&&(e.url=action.url),original_model.save(null,{success:function(t){e.url=copy_of_url,e.change(),n(null,e)},error:function(t,r){e.url=copy_of_url,e.change(),n(r,e)}})},backbone_destroy:function(e,t,n){copy_of_url=e.url,original_model=e.clone(),original_model.url=copy_of_url,action=t.get("action"),action.url&&(e.url=action.url),e.destroy({success:function(t){e.url=copy_of_url,e.change(),n(null,t)},error:function(t,r){e.url=copy_of_url,e.change(),n(r,e)}})},http:function(t,n,r){action=n.get("action");if(!action.url)return r("No action url defined!");wf_opts={},action.http&&(wf_opts=action.http),ajax_options=e.extend({url:action.url,type:"POST",data:t.toJSON(),success:function(){t.fetch({success:function(e){r(null,e)},error:function(e,t){r(t,e)}})}},wf_opts),e.ajax(ajax_options)}}},_init:function(){this._renderers={},this._action_types={},this._parseRenderersAndTypes(),this._last_instance=null,this.ModelWorkflowModel=Backbone.Model.extend({defaults:{name:"",label:"",type:"button",action:{type:"backbone_save"}}}),this.workflows={};var t=this;e(this.element).bind("midgardeditableactivated",function(e,n){t._fetchWorkflows(n.instance)})},_fetchWorkflows:function(e){var t=this;if(e.isNew()){t._trigger("changed",null,{instance:e,workflows:[]});return}if(t._last_instance==e){t.workflows[e.cid]&&t._trigger("changed",null,{instance:e,workflows:t.workflows[e.cid]});return}t._last_instance=e;if(t.workflows[e.cid]){t._trigger("changed",null,{instance:e,workflows:t.workflows[e.cid]});return}t.options.url?t._fetchModelWorkflows(e):(flows=new(t._generateCollectionFor(e))([],{}),t._trigger("changed",null,{instance:e,workflows:flows}))},_parseRenderersAndTypes:function(){var t=this;e.each(this.options.renderers,function(e,n){t.setRenderer(e,n)}),e.each(this.options.action_types,function(e,n){t.setActionType(e,n)})},setRenderer:function(e,t){this._renderers[e]=t},getRenderer:function(e){return this._renderers[e]?this._renderers[e]:!1},setActionType:function(e,t){this._action_types[e]=t},getActionType:function(e){return this
._action_types[e]},prepareItem:function(e,t,n){var r=this;return renderer=this.getRenderer(t.get("type")),action_type_cb=this.getActionType(t.get("action").type),renderer(e,t,action_type_cb,function(i,s){delete r.workflows[e.cid],r._last_instance=null,t.get("action").type!=="backbone_destroy"&&r._fetchModelWorkflows(e),n(i,s)})},_generateCollectionFor:function(e){var t={model:this.ModelWorkflowModel};return this.options.url&&(t.url=this.options.url(e)),Backbone.Collection.extend(t)},_fetchModelWorkflows:function(e){if(e.isNew())return;var t=this;t.workflows[e.cid]=new(this._generateCollectionFor(e))([],{}),t.workflows[e.cid].fetch({success:function(n){t.workflows[e.cid].reset(n.models),t._trigger("changed",null,{instance:e,workflows:t.workflows[e.cid]})},error:function(e,t){}})}})}(jQuery);